# PYSPARK-NOMINA-PJUD

An overengineered ETL for the loading of the corporations manifest of the Chilean tax authority, SII,
implemented as a system of batch jobs with a worker task queue.

The intended architecture is as follows:

      ┌────────────────────────────────────────────────────────┌──────────────┌────────────────────────┐
      │ BATCH-PARSE                      ┌──────────────────┐  │ RMQ          │    WORKERS             │
      │                                  │ OOC-STORAGE      │  │              │                        │
      │   ┌───────┐      ┌─────────┐     │                  │  │              │                        │
      │   │       │      │         │     │┌─────────┐       │  │              │   ┌────────────────┐   │
      │   │  CSV  ├─────►│  SPARK  ├────►││ JSONL   ├───────┼──┼──────────────┼──►│ LOADER-WORKER  │   │
      │   │       │      │         │     │└─────────┘       │  │              │   │                │   │
      │   └───────┘      └────┬────┘     │                  │  │              │   │                │   │
      │                       │          │┌─────────────┐   │  │              │   │                │   │
      │                       ├─────────►││ rejects.dat │   │  │              │   │                │   │
      │                       │          │└─────────────┘   │  │       ┌──────┼──►│                │   │
      │                       │          │                  │  │       │      │   │                │   │
      │                       │          │┌──────────────┐  │  │ ┌─────┴────┐ │   └────────────┬───┘   │
      │                       └─────────►││  mnfst.txt   │  │  │ │          │ │                │       │
      │                                  │└───────┬──────┘  │  │ │          │ │                │       │
      │                                  └────────┼─────────┘  │ │ RABBITMQ │ │                │       │
      ┌───────────────────────────────────────────┼────────────├─┤          │ ├────────────────┼───────┤
      │ ENQUEING-CRON-JOB                         │            │ │          │ │  DB            │       │
      │                   ┌───────────────────────┘            │ └──────────┘ │                │       │
      │   ┌───────────────┼───────────┐                        │       ▲      │                │       │
      │   │ CRON          │           │                        │       │      │                │       │
      │   │  ┌────────────▼────────┐  │                        │       │      │   ┌────────────▼────┐  │
      │   │  │                     │  │                        │       │      │   │                 │  │
      │   │  │ PYTHON ENQUEUER     ├──┼────────────────────────┼───────┘      │   │   POSTGRES      │  │
      │   │  │                     │  │                        ├──────────────┤   │                 │  │
      │   │  └─────────────────────┘  │                        │ MIGRATIONS   │   │                 │  │
      │   └───────────────────────────┘                        │┌───────────┐ │   └─────────▲───────┘  │
      │                                                        ││ FLYWAY    ┼─┼─────────────┘          │
      │                                                        │└───────────┘ │                        │
      └────────────────────────────────────────────────────────└──────────────└────────────────────────┘

